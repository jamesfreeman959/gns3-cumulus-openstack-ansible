# Getting started

## References

- https://docs.openstack.org/openstack-ansible/latest/user/ceph/full-deploy.html (latest unstable release)
- https://docs.openstack.org/openstack-ansible/stein/user/ceph/full-deploy.html (stein release == openstack-ansible 19.x.x)
- https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/run-playbooks.html
- https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/deploymenthost.html
- https://releases.openstack.org/teams/openstackansible.html#ussuri
- https://releases.openstack.org/
- https://docs.openstack.org/openstack-ansible/stein/admin/maintenance-tasks.html#galera-cluster-recovery
- https://docs.ceph.com/ceph-ansible/master/osds/scenarios.html

## Clone the code

1. On the management node, run:

Note - the current instructions don't list the need for (on Ubuntu Server 18.04.4) the ```virtualenv``` packgage - however the bootstrap script will fail if this isn't installed:

```
sudo apt install virtualenv
``` 
Now we'll run the install - this is straight from the prepare deployment host guide at the time of writing, except that we've chosen to use the latest tagged release for OpenStack Stein rather than HEAD.
```
sudo chmod 777 /opt
git clone -b master https://opendev.org/openstack/openstack-ansible /opt/openstack-ansible
cd /opt/openstack-ansible
git checkout 19.0.11
sudo ./scripts/bootstrap-ansible.sh

```

2. Next according to the docs we must prepare the target nodes. This should already be mostly there - for example the bonding and VLAN kernel modules will already be loaded because it's part of our cloud-init invoked networking config. If desired, this configuration could be pushed from the cloud-init ISO on each node - however we do need to reploy the SSH public key created by the ```bootstrap-ansible.sh``` script in the previous step, so it makes sense to deploy the configuration using Ansible here.

This playbook is based upon the documentation from this page - redundant steps such as loading bonding modules have been left out as cloud-init took care of these for us:

https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/targethosts.html

Run the enclosed playbook as follows (local ```sudo``` is required because we need to read ```/root/.ssh/id_rsa``` which was generated by ```bootstrap-ansible.sh```).
```
sudo ansible-playbook -i inventory site.yml --private-key /home/ubuntu/mgmtnet-priv-key --user ubuntu
```

3. From here it's time to prepare our deployment - sample configuration files have been created and stored in this Git repository which should match the network topology and DNS/IP addressing scheme we are using. These should be deployed to /etc/openstack_deploy as follows:

```
sudo cp -r /home/ubuntu/gns3-cumulus-openstack-ansible/6-osansible/etc/openstack_deploy /etc/
```

Then, initialize the secrets (you could also set these manually, but to get started quickly and securely run the following command):
```
cd /opt/openstack-ansible
./scripts/pw-token-gen.py --file /etc/openstack_deploy/user_secrets.yml
```

If you need a reference for these files, or further examples, please explore ```/opt/openstack-ansible/etc```.

Note - you can't change passwords by changing those in this file - they must remain consistent throughout the install and any updates.
Ref: https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/configure.html

Next you must generate the inventory from the config you copied into place earlier.

```
cd /opt/openstack-ansible
./inventory/dynamic_inventory.py --config /etc/openstack_deploy/
```

(ref: https://docs.openstack.org/openstack-ansible/newton/developer-docs/inventory.html)

With this done, you can now run the playbooks (ref: https://docs.openstack.org/project-deploy-guide/openstack-ansible/latest/run-playbooks.html)

To check the YAML formatting/syntax:
```
$ cd playbooks
$ openstack-ansible setup-infrastructure.yml --syntax-check
```

Now we can run the setup-hosts playbook as the first phase of our deployment:

```
openstack-ansible setup-hosts.yml
```

For the next stage to run successfully, you must set the following parameters - these should correspond to a real address and DNS entry from the ```mgmt01``` DNS server:
```
/etc/openstack_deploy/openstack_inventory.json:            "external_lb_vip_address": "openstack.example.org",
/etc/openstack_deploy/openstack_user_config.yml:  external_lb_vip_address: openstack.example.org
```
If you deployed the sample configuration from this repository, this should already be set correctly. However if you need to change this for any reason, edit /etc/openstack_deploy/openstack_user_config.yml, and then run the ```dynamic_inventory.py``` script again.

When this completes successfully, you can then run:

```
openstack-ansible setup-infrastructure.yml
```

Once this runs to completion, you will need to run:
```
openstack-ansible setup-openstack.yml
```

However note that owing to a bug that won't be fixed until the Ussuri release of OpenStack (Github tags 21.x.x for openstack-ansible), the playbook will fail partway through with an error regarding ceilometer. Take note of the hosts where the failure occurs, and then fix manually as follows:

1. SSH to (or open Console) on the affected host, and all others in the HA group (e.g. if it affects compute1, it'll also affect compute2, similarly if it affects infra1, it'll affect infra2 and infra3)
2. ```sudo``` to root
3. If the host is running containers (check with ```lxc-ls```), find the ceilometer container and attach to it using ```lxc-attach```
4. ```cd /openstack/venvs/ceilometer-19.0.11/```
5. ```source bin/activate```
6. ```pip install ujson -U```

Once you have completed the above on all affected nodes, re-run the ```openstack-ansible setup-openstack.yml``` step - this time it should run to completion.

Congratuations! OpenStack is now ready to use. Login at:

https://172.29.236.9
https://openstack.example.org (if you can use the DNS server on mgmt01)

Login username: admin
Login password: <Check value of ```keystone_auth_admin_password``` in ```/etc/openstack_deploy/user_secrets.yml```>


